---
title: Flujo de IntegraciÃ³n GoCardless + Next.js
---

sequenceDiagram
    participant U as ğŸ‘¤ Usuario
    participant F as ğŸ–¥ï¸ Frontend<br/>(React)
    participant B as âš™ï¸ API Routes<br/>(Next.js Server)
    participant DB as ğŸ—„ï¸ Base de Datos<br/>(Supabase/SQLite)
    participant GC as ğŸ¦ GoCardless API
    participant Bank as ğŸ›ï¸ Openbank

    Note over U,Bank: ğŸ” FASE 1: ConexiÃ³n Inicial (Una vez cada 90 dÃ­as)
    
    U->>F: Click "Conectar banco"
    F->>B: POST /api/bank/connect
    B->>GC: POST /requisitions<br/>(institution_id: OPENBANK)
    GC-->>B: { link: "https://ob.gocardless...", requisition_id }
    B->>DB: Guardar requisition_id (pendiente)
    B-->>F: { redirect_url }
    F->>U: Redirigir a GoCardless
    
    U->>GC: Abrir link de autorizaciÃ³n
    GC->>Bank: Redirigir a login Openbank
    U->>Bank: Login + Autorizar acceso
    Bank-->>GC: AutorizaciÃ³n OK
    GC-->>U: Redirigir a /api/bank/callback
    
    U->>B: GET /api/bank/callback?ref=xxx
    B->>GC: GET /requisitions/{id}
    GC-->>B: { accounts: ["acc_123"], status: "LN" }
    B->>DB: Actualizar requisition (linked)<br/>Guardar account_ids
    B-->>F: Redirigir a /dashboard âœ…

    Note over U,Bank: ğŸ”„ FASE 2: Consulta de Datos (DÃ­a a dÃ­a)

    U->>F: Abrir app / Dashboard
    F->>B: GET /api/transactions
    
    B->>DB: Obtener access_token
    
    alt Token expirado (>24h)
        B->>GC: POST /token/new<br/>(secret_id, secret_key)
        GC-->>B: { access_token, expires_in }
        B->>DB: Guardar nuevo token
    end
    
    B->>GC: GET /accounts/{id}/transactions<br/>Header: Authorization: Bearer {token}
    GC-->>B: { transactions: [...] }
    
    opt Guardar histÃ³rico
        B->>DB: Insertar nuevas transacciones
    end
    
    B-->>F: { transactions: [...] }
    F->>U: Mostrar gastos ğŸ“Š

    Note over U,Bank: â° FASE 3: RenovaciÃ³n (Cada 90 dÃ­as)

    U->>F: Abrir app
    F->>B: GET /api/bank/status
    B->>DB: Verificar fecha de conexiÃ³n
    
    alt ConexiÃ³n expirada o prÃ³xima a expirar
        B-->>F: { status: "expired" }
        F->>U: Mostrar aviso:<br/>"Reconecta tu banco"
        Note over U,Bank: Volver a FASE 1
    else ConexiÃ³n vÃ¡lida
        B-->>F: { status: "active", days_left: 45 }
        F->>U: Todo OK âœ…
    end